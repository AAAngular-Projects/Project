<div class="messages-container" *ngIf="canViewMessages(); else accessDenied">
  <!-- Loading state -->
  <div class="messages__loading" *ngIf="isLoading()">
    <p>Loading messages...</p>
    <div class="loading-spinner"></div>
  </div>

  <!-- Error state -->
  <div class="messages__error" *ngIf="hasError() && !isLoading()">
    <p>Error loading messages: {{ error()?.message || 'Unknown error' }}</p>
    <button type="button" (click)="refreshMessages()" class="btn btn--primary">Try Again</button>
  </div>

  <!-- Main messages content -->
  <section class="messages" *ngIf="!isLoading() && !hasError()">
    <header class="messages__header">
      <h2>Messages</h2>
      <div class="messages__actions">
        <span>Unread: {{ unreadCount() }}</span>
        <button 
          type="button" 
          (click)="markAllAsRead()" 
          [disabled]="unreadCount() === 0"
          class="btn btn--secondary"
        >
          Mark all as read
        </button>
        
        <!-- Role-based create button -->
        <button 
          *ngIf="canCreateMessages()"
          type="button" 
          (click)="toggleCreateForm()" 
          class="btn btn--primary"
          [class.active]="createFormVisible()"
        >
          {{ createFormVisible() ? 'Cancel' : 'Create Message' }}
        </button>
      </div>
    </header>

    <div class="messages__content">
      <aside class="messages__list">
        <div class="messages__empty" *ngIf="messages().length === 0">
          <p>No messages found.</p>
        </div>
        
        <button
          *ngFor="let message of messages(); trackBy: trackByUuid"
          type="button"
          class="messages__item"
          [class.messages__item--selected]="selectedMessage()?.uuid === message.uuid"
          [class.messages__item--unread]="!message.readed"
          (click)="selectMessage(message)"
        >
          <p class="messages__item-title">{{ message.templates?.[0]?.subject || 'No subject' }}</p>
          <p class="messages__item-subtitle">
            From {{ message.sender.firstName }} {{ message.sender.lastName }} ·
            {{ message.createdAt | date: 'short' }}
          </p>
        </button>
      </aside>

      <article class="messages__viewer" *ngIf="selectedMessage(); else placeholder">
        <header>
          <h3>{{ selectedMessage()?.templates?.[0]?.subject || 'No subject' }}</h3>
          <p>
            From {{ selectedMessage()?.sender?.firstName }} {{ selectedMessage()?.sender?.lastName }} ·
            {{ selectedMessage()?.createdAt | date: 'medium' }}
          </p>
        </header>
        <div class="messages__body" [innerHTML]="selectedMessage()?.templates?.[0]?.content || 'No content'"></div>
      </article>
    </div>

    <!-- Create Message Form - Only for ADMIN/ROOT -->
    <div class="messages__form" *ngIf="canCreateMessages() && createFormVisible()">
      <h3>Create Message</h3>
      <form [formGroup]="createMessageForm" (ngSubmit)="submit()">
        <div class="form-field">
          <label for="sender">Sender UUID</label>
          <input 
            id="sender" 
            formControlName="sender" 
            class="form-control"
            placeholder="Enter sender UUID"
          />
          <div class="field-error" *ngIf="createMessageForm.get('sender')?.invalid && createMessageForm.get('sender')?.touched">
            Sender is required
          </div>
        </div>
        
        <div class="form-field">
          <label for="recipient">Recipient UUID</label>
          <input 
            id="recipient" 
            formControlName="recipient" 
            class="form-control"
            placeholder="Enter recipient UUID"
          />
          <div class="field-error" *ngIf="createMessageForm.get('recipient')?.invalid && createMessageForm.get('recipient')?.touched">
            Recipient is required
          </div>
        </div>
        
        <div class="form-field">
          <label for="key">Message Key UUID</label>
          <input 
            id="key" 
            formControlName="key" 
            class="form-control"
            placeholder="Enter message key UUID"
          />
          <div class="field-error" *ngIf="createMessageForm.get('key')?.invalid && createMessageForm.get('key')?.touched">
            Message key is required
          </div>
        </div>

        <section formArrayName="templates" class="templates-section">
          <h4>Message Templates</h4>
          <article 
            *ngFor="let template of templates.controls; let i = index; trackBy: trackByIndex"
            class="template" 
            [formGroupName]="i"
          >
            <div class="form-field">
              <label>Language UUID</label>
              <input 
                formControlName="language" 
                class="form-control"
                placeholder="Enter language UUID"
              />
            </div>
            
            <div class="form-field">
              <label>Subject</label>
              <input 
                formControlName="subject" 
                class="form-control"
                placeholder="Enter message subject"
              />
            </div>
            
            <div class="form-field">
              <label>Content</label>
              <textarea 
                formControlName="content" 
                class="form-control"
                rows="4"
                placeholder="Enter message content"
              ></textarea>
            </div>
            
            <div class="form-field">
              <label>Actions (JSON)</label>
              <input 
                formControlName="actions" 
                class="form-control"
                placeholder='[{"param":"value"}]' 
              />
            </div>
            
            <button 
              type="button" 
              class="btn btn--danger btn--small"
              (click)="removeTemplate(i)" 
              [disabled]="templates.length === 1"
            >
              Remove template
            </button>
          </article>
          
          <button type="button" class="btn btn--secondary" (click)="addTemplate()">
            Add template
          </button>
        </section>

        <footer class="form-footer">
          <button 
            type="submit" 
            class="btn btn--primary"
            [disabled]="createMessageForm.invalid || isCreatingMessage()"
          >
            <span *ngIf="isCreatingMessage()">Creating...</span>
            <span *ngIf="!isCreatingMessage()">Create message</span>
          </button>
          
          <button 
            type="button" 
            class="btn btn--secondary" 
            (click)="toggleCreateForm()"
            [disabled]="isCreatingMessage()"
          >
            Cancel
          </button>
        </footer>
      </form>
    </div>
  </section>
</div>

<!-- Access denied template -->
<ng-template #accessDenied>
  <div class="access-denied">
    <h2>Access Denied</h2>
    <p>You don't have permission to view messages.</p>
    <p>Required roles: USER, ADMIN, or ROOT</p>
  </div>
</ng-template>

<!-- Placeholder template -->
<ng-template #placeholder>
  <div class="messages__placeholder">
    <p>Select a message to view its details.</p>
  </div>
</ng-template>
