<div class="dashboard">
  <!-- Header Section -->
  <div class="dashboard-header">
    <div class="welcome-section">
      <h1>Welcome back, {{ currentUser()?.firstName }}!</h1>
      <p class="subtitle">Here's your financial overview</p>
    </div>
  </div>

  <!-- Financial Summary Cards -->
  <div class="summary-cards">
    <!-- Available Funds Card -->
    <div class="summary-card funds-card">
      @if (!availableFunds()) {
        <div class="loading-small">Loading...</div>
      } @else if (availableFunds(); as funds) {
        @if (funds && funds.amountMoney !== undefined) {
          <div class="card-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="1" x2="12" y2="23"></line>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
          </div>
          <div class="card-content">
            <div class="card-label">Available Funds</div>
            <div class="card-value">{{ funds.amountMoney | currency:'USD':'symbol':'1.2-2' }}</div>
            <div class="card-meta">{{ funds.currencyName }}</div>
          </div>
        }
      }
    </div>

    <!-- Revenues Card -->
    @if (accountBalance(); as balance) {
      @if (balance && balance.revenues !== undefined) {
        <div class="summary-card revenues-card">
          <div class="card-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
              <polyline points="17 6 23 6 23 12"></polyline>
            </svg>
          </div>
          <div class="card-content">
            <div class="card-label">Total Revenues</div>
            <div class="card-value positive">{{ balance.revenues | currency:'USD':'symbol':'1.2-2' }}</div>
            <div class="card-meta">{{ balance.currencyName }}</div>
          </div>
        </div>

        <!-- Expenses Card -->
        <div class="summary-card expenses-card">
          <div class="card-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline>
              <polyline points="17 18 23 18 23 12"></polyline>
            </svg>
          </div>
          <div class="card-content">
            <div class="card-label">Total Expenses</div>
            <div class="card-value negative">{{ balance.expenses | currency:'USD':'symbol':'1.2-2' }}</div>
            <div class="card-meta">{{ balance.currencyName }}</div>
          </div>
        </div>

        <!-- Net Balance Card -->
        <div class="summary-card balance-card-small">
          <div class="card-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="2" y="6" width="20" height="12" rx="2"></rect>
              <circle cx="12" cy="12" r="2"></circle>
              <path d="M6 12h.01M18 12h.01"></path>
            </svg>
          </div>
          <div class="card-content">
            <div class="card-label">Net Balance</div>
            <div class="card-value">{{ (+balance.revenues - +balance.expenses) | currency:'USD':'symbol':'1.2-2' }}</div>
            <div class="card-meta">{{ balance.currencyName }}</div>
          </div>
        </div>
      }
    }
  </div>

  <div class="dashboard-grid">
    <!-- Balance History Chart -->
    <div class="card chart-card">
      <div class="card-header">
        <h2>Account Balance History</h2>
      </div>
      <div class="card-content">
        @if (!balanceHistory()) {
          <div class="loading">Loading chart...</div>
        } @else if (balanceHistory(); as history) {
          <div class="chart-container">
            <canvas #balanceChart></canvas>
          </div>
        }
      </div>
    </div>

    <!-- Recent Transactions -->
    <div class="card transactions-card">
      <div class="card-header">
        <h2>Recent Transactions</h2>
        <button class="btn-link" (click)="navigateToTransactions()">View All</button>
      </div>
      <div class="card-content">
        @if (!recentTransactions()) {
          <div class="loading">Loading transactions...</div>
        } @else if (recentTransactions(); as response) {
          @if (response.data && response.data.length > 0) {
            <div class="transactions-list">
              @for (transaction of response.data; track transaction.uuid) {
                <div class="transaction-item">
                  <div class="transaction-info">
                    <div class="transaction-title">{{ transaction.transferTitle }}</div>
                    <div class="transaction-meta">
                      <span>{{ transaction.createdDate | date: 'short' }}</span>
                      <span class="transaction-status" [class.authorized]="transaction.authorizationStatus">
                        {{ transaction.authorizationStatus ? 'Authorized' : 'Pending' }}
                      </span>
                    </div>
                    <div class="transaction-parties">
                      From: {{ transaction.sender?.firstName }} {{ transaction.sender?.lastName }} â†’
                      To: {{ transaction.recipient?.firstName }} {{ transaction.recipient?.lastName }}
                    </div>
                  </div>
                  <div class="transaction-amount" [class.negative]="+transaction.amountMoney < 0">
                    {{ transaction.amountMoney | currency }}
                  </div>
                </div>
              }
            </div>
          } @else {
            <div class="empty-state">No recent transactions</div>
          }
        }
      </div>
    </div>

    <!-- Cards/Bills Section -->
    <div class="card bills-card">
      <div class="card-header">
        <h2>Your Cards & Accounts</h2>
        <button class="btn-link" (click)="navigateToAccounts()">Manage</button>
      </div>
      <div class="card-content">
        @if (!bills()) {
          <div class="loading">Loading cards...</div>
        } @else if (bills(); as billsData) {
          @if (billsData && billsData.data && billsData.data.length > 0) {
            <div class="bills-list">
              @for (bill of billsData.data; track bill.uuid) {
                <div class="bill-item">
                  <div class="bill-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                      <line x1="1" y1="10" x2="23" y2="10"></line>
                    </svg>
                  </div>
                  <div class="bill-info">
                    <div class="bill-number">**** {{ bill.accountBillNumber.slice(-4) }}</div>
                    <div class="bill-currency">{{ bill.currency.name }}</div>
                  </div>
                  <div class="bill-amount">
                    @if (bill.amountMoney) {
                      {{ bill.amountMoney | currency:'USD':'symbol':'1.2-2' }}
                    }
                  </div>
                </div>
              }
            </div>
          } @else {
            <div class="empty-state">No cards found</div>
          }
        }
      </div>
    </div>

    <!-- Exchange Rate History Chart -->
    <app-exchange-rate-chart></app-exchange-rate-chart>

    <!-- Quick Actions -->
    <div class="card actions-card">
      <div class="card-header">
        <h2>Quick Actions</h2>
      </div>
      <div class="card-content">
        <div class="actions-grid">
          <button class="action-btn" (click)="makeTransfer()">
            <span class="action-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
              </svg>
            </span>
            <span class="action-label">Make Transfer</span>
          </button>
          <button class="action-btn" (click)="navigateToTransactions()">
            <span class="action-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
              </svg>
            </span>
            <span class="action-label">View Transactions</span>
          </button>
          <button class="action-btn" (click)="navigateToAccounts()">
            <span class="action-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 21h18"></path>
                <path d="M3 10h18"></path>
                <path d="M5 6l7-3 7 3"></path>
                <path d="M4 10v11"></path>
                <path d="M20 10v11"></path>
                <path d="M8 14v3"></path>
                <path d="M12 14v3"></path>
                <path d="M16 14v3"></path>
              </svg>
            </span>
            <span class="action-label">Manage Accounts</span>
          </button>
          <button class="action-btn" (click)="navigateToSettings()">
            <span class="action-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M12 1v6m0 6v6m5.66-13l-4.3 4.3m-2.72 2.72L6.34 17.66M23 12h-6m-6 0H5m13.66 5.66l-4.3-4.3m-2.72-2.72l-4.3-4.3"></path>
              </svg>
            </span>
            <span class="action-label">Settings</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Transfer Modal -->
@if (showTransferModal()) {
  <div class="modal-overlay" (click)="closeTransferModal()">
    <div
      class="modal-content transfer-modal"
      role="dialog"
      aria-modal="true"
      aria-labelledby="transfer-modal-title"
      (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 id="transfer-modal-title">
          @switch (transferStep()) {
            @case ('form') { Make Transfer }
            @case ('confirm') { Confirm Transfer }
            @case ('success') { Transfer Complete }
          }
        </h2>
        <button class="btn-close" (click)="closeTransferModal()" aria-label="Close">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        @switch (transferStep()) {
          @case ('form') {
            <form [formGroup]="transferForm">
              <!-- Sender Account -->
              <div class="form-group">
                <label for="senderBill">From Account</label>
                <select id="senderBill" formControlName="senderBill" class="form-control">
                  <option value="">Select an account</option>
                  @for (account of senderAccounts(); track account.id) {
                    <option [value]="account.id">
                      **** {{ account.accountNumber.slice(-4) }} - {{ account.currency }} ({{ account.balance | currency:account.currency:'symbol':'1.2-2' }})
                    </option>
                  }
                </select>
                @if (transferForm.get('senderBill')?.invalid && transferForm.get('senderBill')?.touched) {
                  <span class="error-text">Please select a sender account</span>
                }
              </div>

              <!-- Recipient Search -->
              <div class="form-group recipient-search">
                <label for="recipientSearch">To (Recipient)</label>
                @if (selectedRecipient()) {
                  <div class="selected-recipient">
                    <div class="recipient-info">
                      <span class="recipient-name">
                        @if (selectedRecipient()?.user) {
                          {{ selectedRecipient()?.user?.firstName }} {{ selectedRecipient()?.user?.lastName }}
                        } @else {
                          Unknown
                        }
                      </span>
                      <span class="recipient-account">****{{ selectedRecipient()?.accountBillNumber?.slice(-4) }}</span>
                    </div>
                    <button type="button" class="btn-clear" (click)="clearRecipient()">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                      </svg>
                    </button>
                  </div>
                } @else {
                  <div class="search-input-wrapper">
                    <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="11" cy="11" r="8"></circle>
                      <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <input
                      type="text"
                      id="recipientSearch"
                      [formControl]="recipientSearchControl"
                      placeholder="Search by recipient name..."
                      class="form-control search-input"
                    />
                    @if (searchLoading()) {
                      <div class="search-spinner"></div>
                    }
                  </div>

                  <!-- Search Results Dropdown -->
                  @if (recipientSearchResults().length > 0) {
                    <div class="search-results">
                      @for (result of recipientSearchResults(); track result.uuid) {
                        <div class="search-result-item" (click)="selectRecipient(result)">
                          <div class="result-info">
                            <span class="result-name">
                              @if (result.user) {
                                {{ result.user.firstName }} {{ result.user.lastName }}
                              } @else {
                                Unknown
                              }
                            </span>
                            <span class="result-account">****{{ result.accountBillNumber.slice(-4) }}</span>
                          </div>
                          <span class="result-currency">{{ result.currency.name }}</span>
                        </div>
                      }
                    </div>
                  }
                }
              </div>

              <!-- Amount -->
              <div class="form-group">
                <label for="amount">Amount</label>
                <input
                  type="number"
                  id="amount"
                  formControlName="amount"
                  placeholder="0.00"
                  class="form-control"
                  min="0.01"
                  step="0.01"
                />
                @if (transferForm.get('amount')?.invalid && transferForm.get('amount')?.touched) {
                  <span class="error-text">Please enter a valid amount (min: 0.01)</span>
                }
              </div>

              <!-- Transfer Note -->
              <div class="form-group">
                <label for="note">Transfer Title/Note</label>
                <input
                  type="text"
                  id="note"
                  formControlName="note"
                  placeholder="Enter transfer description..."
                  class="form-control"
                />
                @if (transferForm.get('note')?.invalid && transferForm.get('note')?.touched) {
                  <span class="error-text">Please enter a transfer note</span>
                }
              </div>

              <!-- Language -->
              <div class="form-group">
                <label for="locale">Confirmation Language</label>
                <select id="locale" formControlName="locale" class="form-control">
                  @for (lang of languages; track lang.value) {
                    <option [value]="lang.value">{{ lang.label }}</option>
                  }
                </select>
              </div>

              <!-- Error Message -->
              @if (transferError()) {
                <div class="error-message">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                  </svg>
                  <span>{{ transferError() }}</span>
                </div>
              }
            </form>
          }

          @case ('confirm') {
            @if (pendingTransaction(); as transaction) {
              <app-transaction-confirmation
                [transaction]="transaction"
                [showSkipOption]="true"
                (confirmed)="onTransactionConfirmed()"
                (skipped)="onConfirmationSkipped()"
                (cancelled)="onConfirmationCancelled()" />
            }
          }

          @case ('success') {
            <div class="success-message">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
              </svg>
              <p>Transfer confirmed successfully!</p>
            </div>
          }
        }
      </div>

      @if (transferStep() === 'form') {
        <div class="modal-footer">
          <button class="btn-secondary" (click)="closeTransferModal()" [disabled]="transferLoading()">
            Cancel
          </button>
          <button
            class="btn-primary"
            (click)="submitTransfer()"
            [disabled]="transferLoading() || !selectedRecipient() || transferForm.invalid"
          >
            @if (transferLoading()) {
              <span class="btn-spinner"></span>
              Processing...
            } @else {
              Create Transfer
            }
          </button>
        </div>
      }
    </div>
  </div>
}
