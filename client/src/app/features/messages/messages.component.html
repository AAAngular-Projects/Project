<div class="messages-container" *ngIf="canViewMessages(); else accessDenied">
  <!-- Loading state -->
  <div class="messages__loading" *ngIf="isLoading()">
    <p>Loading messages...</p>
    <div class="loading-spinner"></div>
  </div>

  <!-- Error state -->
  <div class="messages__error" *ngIf="hasError() && !isLoading()">
    <p>Error loading messages: {{ error()?.message || 'Unknown error' }}</p>
    <button type="button" (click)="refreshMessages()" class="btn btn--primary">Try Again</button>
  </div>

  <!-- Main messages content -->
  <section class="messages" *ngIf="!isLoading() && !hasError()">
    <header class="messages__header">
      <h2>Messages</h2>
      <div class="messages__actions">
        <span>Unread: {{ unreadCount() }}</span>
        <button 
          type="button" 
          (click)="markAllAsRead()" 
          [disabled]="unreadCount() === 0"
          class="btn btn--secondary"
        >
          Mark all as read
        </button>
        
        <!-- Role-based create button -->
        <button 
          *ngIf="canCreateMessages()"
          type="button" 
          (click)="toggleCreateForm()" 
          class="btn btn--primary"
          [class.active]="createFormVisible()"
        >
          {{ createFormVisible() ? 'Cancel' : 'Create Message' }}
        </button>
      </div>
    </header>

    <div class="messages__content">
      <aside class="messages__list">
        <div class="messages__empty" *ngIf="messages().length === 0">
          <p>No messages found.</p>
        </div>
        
        <button
          *ngFor="let message of messages(); trackBy: trackByUuid"
          type="button"
          class="messages__item"
          [class.messages__item--selected]="selectedMessage()?.uuid === message.uuid"
          [class.messages__item--unread]="!message.readed"
          (click)="selectMessage(message)"
        >
          <p class="messages__item-title">{{ message.templates[0]?.subject || 'No subject' }}</p>
          <p class="messages__item-subtitle">
            From {{ message.sender.firstName }} {{ message.sender.lastName }} ·
            {{ message.createdAt | date: 'short' }}
          </p>
        </button>
      </aside>

      <article class="messages__viewer" *ngIf="selectedMessage(); else placeholder">
        <header>
          <h3>{{ selectedMessage()?.templates?.[0]?.subject || 'No subject' }}</h3>
          <p>
            From {{ selectedMessage()?.sender?.firstName }} {{ selectedMessage()?.sender?.lastName }} ·
            {{ selectedMessage()?.createdAt | date: 'medium' }}
          </p>
        </header>
        <div class="messages__body" [innerHTML]="selectedMessage()?.templates?.[0]?.content || 'No content'"></div>
      </article>
    </div>

    <!-- Create Message Form - Simplified - Only for ADMIN/ROOT -->
    <div class="messages__form" *ngIf="canCreateMessages() && createFormVisible()">
      <h3>Create Message</h3>
      <form [formGroup]="createMessageForm" (ngSubmit)="submit()">
        <div class="sender-info" *ngIf="currentUser()">
          <p><strong>From:</strong> {{ currentUser()?.firstName }} {{ currentUser()?.lastName }} (PIN: {{ currentUser()?.userAuth?.pinCode }})</p>
        </div>
        
        <div class="form-field">
          <label for="recipient">Recipient PIN Code</label>
          <input 
            id="recipient" 
            formControlName="recipient" 
            class="form-control"
            type="number"
            placeholder="Enter recipient PIN code"
            min="100000"
            max="999999"
          />
          <div class="field-error" *ngIf="createMessageForm.get('recipient')?.invalid && createMessageForm.get('recipient')?.touched">
            Please enter a valid 6-digit PIN code
          </div>
        </div>
        
        <div class="form-field">
          <label for="subject">Subject</label>
          <input 
            id="subject" 
            formControlName="subject" 
            class="form-control"
            placeholder="Enter message subject"
          />
          <div class="field-error" *ngIf="createMessageForm.get('subject')?.invalid && createMessageForm.get('subject')?.touched">
            Subject is required
          </div>
        </div>
        
        <div class="form-field">
          <label for="content">Content</label>
          <textarea 
            id="content"
            formControlName="content" 
            class="form-control"
            rows="6"
            placeholder="Enter message content"
          ></textarea>
          <div class="field-error" *ngIf="createMessageForm.get('content')?.invalid && createMessageForm.get('content')?.touched">
            Content is required
          </div>
        </div>

        <footer class="form-footer">
          <button 
            type="submit" 
            class="btn btn--primary"
            [disabled]="createMessageForm.invalid || isCreatingMessage()"
          >
            <span *ngIf="isCreatingMessage()">Creating...</span>
            <span *ngIf="!isCreatingMessage()">Send Message</span>
          </button>
          
          <button 
            type="button" 
            class="btn btn--secondary" 
            (click)="toggleCreateForm()"
            [disabled]="isCreatingMessage()"
          >
            Cancel
          </button>
        </footer>
      </form>
    </div>
  </section>
</div>

<!-- Access denied template -->
<ng-template #accessDenied>
  <div class="access-denied">
    <h2>Access Denied</h2>
    <p>You don't have permission to view messages.</p>
    <p>Required roles: USER, ADMIN, or ROOT</p>
  </div>
</ng-template>

<!-- Placeholder template -->
<ng-template #placeholder>
  <div class="messages__placeholder">
    <p>Select a message to view its details.</p>
  </div>
</ng-template>
