<section class="budget-analytics-container">
  <header class="page-header">
    <h1>Budget & Analytics</h1>
    <div class="header-controls">
      <div class="month-year-selector">
        <select [value]="selectedMonth()" (change)="onMonthChange($event)">
          <option [value]="1">January</option>
          <option [value]="2">February</option>
          <option [value]="3">March</option>
          <option [value]="4">April</option>
          <option [value]="5">May</option>
          <option [value]="6">June</option>
          <option [value]="7">July</option>
          <option [value]="8">August</option>
          <option [value]="9">September</option>
          <option [value]="10">October</option>
          <option [value]="11">November</option>
          <option [value]="12">December</option>
        </select>
        <input
          type="number"
          [value]="selectedYear()"
          (input)="onYearInput($event)"
          min="2000"
          max="2100"
        />
      </div>
      <button (click)="toggleCreateForm()" class="btn-primary">
        {{ showCreateForm() ? 'Cancel' : 'Create Budget' }}
      </button>
    </div>
  </header>

  @if (showCreateForm()) {
  <section class="create-form">
    <h2>Create New Budget</h2>
    <div class="form-group">
      <label for="category">Category</label>
      <select
        id="category"
        [value]="newBudget().category"
        (change)="onCategoryChange($event)"
      >
        @for (cat of categories; track cat) {
        <option [value]="cat">{{ cat }}</option>
        }
      </select>
    </div>
    <div class="form-group">
      <label for="limitAmount">Budget Limit</label>
      <input
        id="limitAmount"
        type="number"
        [value]="newBudget().limitAmount"
        (input)="onLimitAmountInput($event)"
        min="0"
        step="0.01"
      />
    </div>
    <button (click)="createBudget()" class="btn-success">Create Budget</button>
  </section>
  }

  @if (!hasUserSelectedPeriod()) {
  <div class="welcome-state">
    <h2>Welcome to Budget Analytics</h2>
    <p>Select a month and year above to view your budget and spending analytics.</p>
  </div>
  } @else {
  @if (isLoading()) {
  <div class="loading">Loading budgets...</div>
  } @else {
  <section class="overview">
    <div class="overview-card">
      <h3>Total Budget</h3>
      <p class="amount">${{ totalBudget() | number:'1.2-2' }}</p>
    </div>
    <div class="overview-card">
      <h3>Total Spent</h3>
      <p class="amount spent">${{ totalSpent() | number:'1.2-2' }}</p>
    </div>
    <div class="overview-card">
      <h3>Overall Usage</h3>
      <p class="amount">{{ overallPercentage() }}%</p>
    </div>
  </section>

  <!-- Chart section - always rendered so ViewChild is available -->
  <section class="chart-section">
    <h2>Spending Distribution</h2>
    <div class="chart-container">
      <canvas #spendingChart></canvas>
    </div>
  </section>

  @if (analytics().length > 0) {
  <section class="budgets-section">
    <h2>Budget Details</h2>
    <div class="budgets-list">
      @for (analytic of analytics(); track analytic.category) {
      <article class="budget-item">
        <div class="budget-header">
          <div class="category-info">
            <div
              class="category-color"
              [style.background]="getCategoryColor(analytic.category)"
            ></div>
            <h3>{{ analytic.category }}</h3>
          </div>
          <div class="budget-amounts">
            <span class="spent">${{ analytic.spentAmount | number:'1.2-2' }}</span>
            <span class="separator">/</span>
            <span class="limit">${{ analytic.limitAmount | number:'1.2-2' }}</span>
          </div>
        </div>
        <div class="budget-progress">
          <div class="progress-bar">
            <div
              class="progress-fill"
              [class.over-budget]="analytic.percentageUsed > 100"
              [style.width.%]="Math.min(analytic.percentageUsed, 100)"
            ></div>
          </div>
          <span class="percentage">{{ analytic.percentageUsed }}%</span>
        </div>
        <div class="budget-footer">
          <span class="remaining">
            Remaining: ${{ analytic.remainingAmount | number:'1.2-2' }}
          </span>
          <button (click)="deleteBudget(getBudgetIdByCategory(analytic.category))" class="btn-small btn-danger">
            Delete
          </button>
        </div>
      </article>
      }
    </div>
  </section>
  } @else {
  <div class="empty-state">
    <p>No budgets created for this month. Create a budget to start tracking your spending!</p>
  </div>
  }
  }
  }
</section>
